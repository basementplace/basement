<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Basement | Избранное</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        /* Стили для модального окна детальной страницы */
        .product-detail {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--ozon-gray-10);
            z-index: 1200;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 500px;
            margin: 0 auto;
        }

        .product-detail.active {
            transform: translateY(0);
        }

        .detail-header {
            position: sticky;
            top: 0;
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 16px;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .detail-close {
            width: 40px;
            height: 40px;
            background: var(--ozon-gray-30);
            border: 1px solid var(--ozon-gray-40);
            border-radius: 12px;
            color: var(--ozon-white);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .detail-close:hover {
            background: var(--ozon-red);
            border-color: var(--ozon-red);
            transform: rotate(90deg);
        }

        .detail-images {
            height: 400px;
            position: relative;
            overflow: hidden;
        }

        .image-slider {
            display: flex;
            height: 100%;
            transition: transform 0.4s ease;
        }

        .image-slide {
            min-width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--ozon-gray-30), var(--ozon-gray-20));
        }

        .image-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0 0 20px 20px;
        }

        .slider-controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .slider-dot {
            width: 8px;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .slider-dot.active {
            background: var(--ozon-white);
            transform: scale(1.2);
        }

        .detail-content {
            padding: 24px 16px;
        }

        .detail-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
            line-height: 1.3;
        }

        .detail-meta {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            color: var(--ozon-gray-50);
            font-size: 14px;
        }

        .detail-price {
            display: flex;
            align-items: baseline;
            gap: 12px;
            margin-bottom: 24px;
        }

        .detail-current {
            font-size: 32px;
            font-weight: 800;
            color: var(--ozon-white);
        }

        .detail-old {
            font-size: 20px;
            color: var(--ozon-gray-50);
            text-decoration: line-through;
        }

        .detail-description {
            font-size: 15px;
            line-height: 1.6;
            color: var(--ozon-gray-70);
            margin-bottom: 32px;
        }

        /* REVIEWS SECTION */
        .reviews-section {
            margin-top: 32px;
            border-top: 1px solid var(--ozon-gray-30);
            padding-top: 24px;
        }

        .reviews-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .reviews-title {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .add-review-btn {
            background: var(--ozon-blue);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all var(--transition-base);
        }

        .add-review-btn:hover {
            background: var(--ozon-blue-dark);
            transform: translateY(-2px);
        }

        .average-rating {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding: 16px;
            background: var(--ozon-gray-20);
            border-radius: 16px;
            border: 1px solid var(--ozon-gray-30);
        }

        .average-rating-value {
            font-size: 36px;
            font-weight: 800;
            color: var(--ozon-white);
        }

        .average-rating-details {
            flex: 1;
        }

        .average-rating-stars {
            font-size: 18px;
            color: var(--ozon-orange);
            margin-bottom: 4px;
        }

        .average-rating-text {
            font-size: 14px;
            color: var(--ozon-gray-50);
        }

        .rating-bars {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .rating-bar {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rating-bar-label {
            font-size: 12px;
            color: var(--ozon-gray-50);
            min-width: 40px;
        }

        .rating-bar-progress {
            flex: 1;
            height: 6px;
            background: var(--ozon-gray-30);
            border-radius: 3px;
            overflow: hidden;
        }

        .rating-bar-fill {
            height: 100%;
            background: var(--ozon-orange);
            border-radius: 3px;
        }

        .rating-bar-count {
            font-size: 12px;
            color: var(--ozon-gray-50);
            min-width: 20px;
        }

        .reviews-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .review-item {
            background: var(--ozon-gray-20);
            border: 1px solid var(--ozon-gray-30);
            border-radius: 16px;
            padding: 16px;
        }

        .review-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .review-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--ozon-blue), var(--ozon-orange));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--ozon-white);
            font-weight: 600;
            font-size: 16px;
        }

        .review-user {
            flex: 1;
        }

        .review-user-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .review-date {
            font-size: 12px;
            color: var(--ozon-gray-50);
        }

        .review-rating {
            color: var(--ozon-orange);
            font-size: 14px;
        }

        .review-text {
            font-size: 14px;
            line-height: 1.5;
            color: var(--ozon-gray-70);
            margin-bottom: 12px;
        }

        .review-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--ozon-gray-50);
        }

        .no-reviews {
            text-align: center;
            padding: 40px 20px;
            color: var(--ozon-gray-50);
        }

        .no-reviews i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* REVIEW MODAL */
        .review-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--ozon-gray-10);
            z-index: 1300;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 500px;
            margin: 0 auto;
        }

        .review-modal.active {
            transform: translateY(0);
        }

        .review-modal-header {
            position: sticky;
            top: 0;
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 16px;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--ozon-gray-30);
        }

        .review-modal-title {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .review-modal-close {
            width: 40px;
            height: 40px;
            background: var(--ozon-gray-30);
            border: 1px solid var(--ozon-gray-40);
            border-radius: 12px;
            color: var(--ozon-white);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .review-modal-close:hover {
            background: var(--ozon-red);
            border-color: var(--ozon-red);
            transform: rotate(90deg);
        }

        .review-modal-content {
            padding: 24px 16px;
        }

        .rating-input {
            margin-bottom: 24px;
        }

        .rating-input label {
            display: block;
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .stars-input {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 16px;
        }

        .star-btn {
            background: none;
            border: none;
            font-size: 32px;
            color: var(--ozon-gray-30);
            cursor: pointer;
            transition: all var(--transition-base);
            padding: 0;
        }

        .star-btn:hover {
            transform: scale(1.2);
        }

        .star-btn.active {
            color: var(--ozon-orange);
        }

        .selected-rating-text {
            text-align: center;
            font-size: 14px;
            color: var(--ozon-gray-50);
            margin-bottom: 8px;
        }

        .review-form-group {
            margin-bottom: 20px;
        }

        .review-form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .review-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            background: var(--ozon-gray-20);
            border: 1px solid var(--ozon-gray-30);
            border-radius: 12px;
            color: var(--ozon-white);
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            resize: vertical;
            outline: none;
            transition: all var(--transition-base);
        }

        .review-textarea:focus {
            border-color: var(--ozon-blue);
            box-shadow: var(--shadow-blue);
        }

        .review-form-actions {
            position: sticky;
            bottom: 0;
            padding: 16px;
            background: var(--ozon-gray-10);
            border-top: 1px solid var(--ozon-gray-30);
            display: flex;
            gap: 12px;
        }

        .review-error {
            color: var(--ozon-red);
            font-size: 14px;
            margin-bottom: 16px;
            text-align: center;
            padding: 8px;
            background: rgba(255, 59, 48, 0.1);
            border-radius: 8px;
            border: 1px solid var(--ozon-red);
            display: none;
        }

        .review-error.show {
            display: block;
        }

        .specs-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }

        .spec-item {
            background: var(--ozon-gray-20);
            border: 1px solid var(--ozon-gray-30);
            border-radius: 12px;
            padding: 16px;
        }

        .spec-label {
            font-size: 12px;
            color: var(--ozon-gray-50);
            margin-bottom: 4px;
        }

        .spec-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--ozon-white);
        }

        .detail-actions {
            position: sticky;
            bottom: 0;
            padding: 16px;
            background: var(--ozon-gray-10);
            border-top: 1px solid var(--ozon-gray-30);
            display: flex;
            gap: 12px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-base);
            border: none;
            outline: none;
            position: relative;
            overflow: hidden;
            text-decoration: none;
            user-select: none;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--ozon-blue), var(--ozon-blue-dark));
            color: var(--ozon-white);
            box-shadow: var(--shadow-blue);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--ozon-blue-dark), var(--ozon-blue));
            box-shadow: 0 6px 24px rgba(0, 91, 255, 0.35);
            transform: translateY(-2px);
        }

        .btn-primary:active {
            transform: translateY(0) scale(0.98);
        }

        .btn-accent {
            background: linear-gradient(135deg, var(--ozon-orange), #FF7A00);
            color: var(--ozon-white);
            box-shadow: var(--shadow-orange);
        }

        .btn-accent:hover {
            background: linear-gradient(135deg, #FF7A00, var(--ozon-orange));
            box-shadow: 0 6px 24px rgba(255, 153, 0, 0.35);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--ozon-gray-30);
            color: var(--ozon-white);
            border: 1px solid var(--ozon-gray-40);
        }

        .btn-secondary:hover {
            background: var(--ozon-gray-40);
            border-color: var(--ozon-gray-50);
            transform: translateY(-2px);
        }

        /* Стили для страницы избранного */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --ozon-blue: #005BFF;
            --ozon-blue-dark: #004ECC;
            --ozon-green: #00D68F;
            --ozon-green-dark: #00B877;
            --ozon-gray-10: #1A1A1A;
            --ozon-gray-20: #2C2C2E;
            --ozon-gray-30: #3C3C3E;
            --ozon-gray-40: #48484A;
            --ozon-gray-50: #8E8E93;
            --ozon-white: #FFFFFF;
            --glass-bg: rgba(44, 44, 46, 0.8);
            --glass-border: rgba(255, 255, 255, 0.1);
            --success-green: #34C759;
            --error-red: #FF3B30;
            --warning-yellow: #FF9500;
            --favorite-pink: #FF2D55;
            --ozon-orange: #F90;
            --ozon-red: #FF3B30;
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --shadow-blue: 0 4px 20px rgba(0, 91, 255, 0.25);
        }

        body {
            background: linear-gradient(135deg, #0A0A0A 0%, #1A1A1A 100%);
            color: var(--ozon-white);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 80%, rgba(0, 91, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 153, 0, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 0 16px 100px;
        }

        .header {
            padding: 20px 0 16px;
            margin-bottom: 4px;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            color: var(--ozon-white);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            padding: 12px 16px;
            border-radius: 14px;
            transition: all 0.3s ease;
            margin-bottom: 16px;
            width: fit-content;
            animation: slideDown 0.3s ease-out;
        }

        .back-btn:hover {
            background: rgba(44, 44, 46, 0.9);
            border-color: var(--ozon-blue);
            transform: translateY(-2px);
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideUp 0.6s ease-out 0.1s both;
        }

        .favorites-count {
            background: var(--ozon-blue);
            color: var(--ozon-white);
            font-size: 14px;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
            animation: scaleIn 0.4s ease-out;
        }

        .favorites-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .product-card {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
            animation: scaleIn 0.4s ease-out;
            animation-fill-mode: both;
            cursor: pointer;
        }

        .product-card:nth-child(1) {
            animation-delay: 0.2s;
        }

        .product-card:nth-child(2) {
            animation-delay: 0.3s;
        }

        .product-card:hover {
            transform: translateY(-4px);
            border-color: var(--ozon-blue);
            box-shadow: 0 8px 32px rgba(0, 91, 255, 0.25);
        }

        .favorite-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            background: rgba(44, 44, 46, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--favorite-pink);
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
        }

        .favorite-btn.active {
            color: var(--favorite-pink);
            background: rgba(44, 44, 46, 0.95);
            border-color: rgba(255, 45, 85, 0.3);
        }

        .favorite-btn:hover {
            background: rgba(44, 44, 46, 1);
            transform: scale(1.1);
        }

        .product-image {
            width: 100%;
            height: 180px;
            overflow: hidden;
            position: relative;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.6s ease;
        }

        .product-card:hover .product-image img {
            transform: scale(1.1);
        }

        .product-info {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .product-category {
            font-size: 11px;
            color: var(--ozon-gray-50);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .product-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            line-height: 1.3;
            height: 36px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .product-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 4px;
        }

        .stars {
            color: var(--ozon-orange);
            font-size: 12px;
        }

        .rating-value {
            font-size: 12px;
            font-weight: 600;
            color: var(--ozon-white);
        }

        .rating-count {
            font-size: 11px;
            color: var(--ozon-gray-50);
        }

        .product-price {
            font-size: 18px;
            font-weight: 700;
            color: var(--ozon-white);
        }

        .old-price {
            font-size: 14px;
            color: var(--ozon-gray-50);
            text-decoration: line-through;
            margin-left: 6px;
        }

        /* ОБНОВЛЕННЫЕ КНОПКИ КОРЗИНЫ - БЕЗ ЗЕЛЕНОЙ КНОПКИ "В КОРЗИНЕ" */
        .cart-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .add-to-cart-btn {
            flex: 1;
            padding: 10px 12px;
            background: var(--ozon-blue);
            border: none;
            border-radius: 12px;
            color: var(--ozon-white);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .add-to-cart-btn:hover {
            background: var(--ozon-blue-dark);
            transform: translateY(-2px);
        }

        /* УБРАТЬ КЛАСС .added И ВСЕ СВЯЗАННЫЕ С НИМ СТИЛИ */
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--ozon-gray-30);
            border: 1px solid var(--ozon-gray-40);
            border-radius: 12px;
            padding: 4px;
            animation: scaleIn 0.3s ease-out;
            width: 100%;
            justify-content: space-between;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            background: var(--ozon-gray-20);
            border: none;
            border-radius: 8px;
            color: var(--ozon-white);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .qty-btn:hover {
            background: var(--ozon-gray-40);
        }

        .qty-btn:active {
            transform: scale(0.95);
        }

        .quantity {
            min-width: 32px;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
            color: var(--ozon-white);
        }

        .empty-favorites {
            text-align: center;
            padding: 60px 20px;
            animation: fadeIn 0.6s ease;
        }

        .empty-favorites i {
            font-size: 64px;
            color: var(--ozon-gray-30);
            margin-bottom: 24px;
            opacity: 0.5;
        }

        .empty-favorites h3 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .empty-favorites p {
            color: var(--ozon-gray-50);
            margin-bottom: 24px;
        }

        .auth-container {
            text-align: center;
            padding: 40px 20px;
        }

        .auth-btn {
            background: var(--ozon-blue);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 auto 20px;
            transition: all 0.3s ease;
        }

        .auth-btn:hover {
            background: var(--ozon-blue-dark);
            transform: translateY(-2px);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--ozon-gray-50);
        }

        .loading i {
            font-size: 32px;
            margin-bottom: 16px;
            animation: spin 1s linear infinite;
        }

        .error-message {
            text-align: center;
            padding: 40px 20px;
            color: #FF3B30;
        }

        .error-message i {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .retry-btn {
            background: var(--ozon-blue);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .retry-btn:hover {
            background: var(--ozon-blue-dark);
            transform: translateY(-2px);
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--ozon-gray-20);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            max-width: 90%;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.success {
            background: rgba(40, 167, 69, 0.9);
        }

        .toast.error {
            background: rgba(220, 53, 69, 0.9);
        }

        .toast.info {
            background: rgba(23, 162, 184, 0.9);
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @media (max-width: 480px) {
            .favorites-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .product-image {
                height: 160px;
            }
            
            .cart-controls {
                flex-direction: column;
                gap: 8px;
            }
            
            .add-to-cart-btn,
            .quantity-controls {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <button class="back-btn glass" onclick="window.history.back()">
                <i class="fas fa-arrow-left"></i> Назад
            </button>
            <div class="page-header">
                <h1 class="page-title">
                    <i class="fas fa-heart" style="color: var(--ozon-blue);"></i> Избранное
                </h1>
                <div class="favorites-count" id="favoritesCount">
                    <i class="fas fa-heart"></i>
                    <span id="favoritesCountValue">0</span>
                </div>
            </div>
        </div>

        <!-- ОБНОВЛЕННЫЙ КОНТЕЙНЕР ДЛЯ НЕАВТОРИЗОВАННЫХ ПОЛЬЗОВАТЕЛЕЙ -->
        <div id="authContainer" class="auth-container" style="display: none;">
            <h3 style="margin-bottom: 20px;">Войдите, чтобы видеть избранное</h3>
            <button id="signInBtn" class="auth-btn">
                <i class="fas fa-user-circle"></i> Войти в профиль
            </button>
            <p style="color: var(--ozon-gray-50); margin-top: 20px;">
                Избранное будет сохранено в вашем аккаунте
            </p>
        </div>

        <div id="loadingContainer" class="loading" style="display: none;">
            <i class="fas fa-spinner"></i>
            <p>Загрузка избранного...</p>
        </div>

        <div id="errorContainer" class="error-message" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Не удалось загрузить избранное</h3>
            <p id="errorText">Проверьте подключение к интернету и попробуйте снова</p>
            <button id="retryBtn" class="retry-btn">Попробовать снова</button>
        </div>

        <div id="favoritesContainer" class="favorites-grid">
            <!-- Товары будут загружены через JavaScript -->
        </div>

        <div class="empty-favorites" id="emptyFavorites" style="display: none;">
            <i class="fas fa-heart"></i>
            <h3>Нет избранных товаров</h3>
            <p>Добавьте товары в избранное из магазина</p>
            <button class="auth-btn" onclick="window.location.href='index.html'">
                <i class="fas fa-store"></i> Перейти в магазин
            </button>
        </div>
    </div>

    <!-- Модальное окно детальной страницы товара (как на главной) -->
    <div class="product-detail" id="productDetail">
        <div class="detail-header">
            <button class="detail-close" onclick="closeProductDetail()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="detail-images">
            <div class="image-slider" id="imageSlider"></div>
            <div class="slider-controls" id="sliderControls"></div>
        </div>

        <div class="detail-content">
            <h1 class="detail-title" id="detailTitle"></h1>
            <div class="detail-meta">
                <span><i class="fas fa-tag"></i> <span id="detailCategory"></span></span>
                <span><i class="fas fa-star"></i> <span id="detailRating"></span></span>
                <span><i class="fas fa-heart"></i> В избранном</span>
            </div>
            <div class="detail-price">
                <span class="detail-current" id="detailCurrentPrice"></span>
                <span class="detail-old" id="detailOldPrice"></span>
            </div>
            <div class="detail-description" id="detailDescription"></div>

            <div class="specs-grid">
                <div class="spec-item">
                    <div class="spec-label">Бренд</div>
                    <div class="spec-value" id="specBrand"></div>
                </div>
                <div class="spec-item">
                    <div class="spec-label">Тип кожи</div>
                    <div class="spec-value" id="specSkinType"></div>
                </div>
                <div class="spec-item">
                    <div class="spec-label">Объем</div>
                    <div class="spec-value" id="specVolume"></div>
                </div>
                <div class="spec-item">
                    <div class="spec-label">Страна</div>
                    <div class="spec-value" id="specCountry"></div>
                </div>
            </div>

            <!-- Reviews Section -->
            <div class="reviews-section" id="reviewsSection">
                <div class="reviews-header">
                    <h3 class="reviews-title">
                        <i class="fas fa-comment-alt"></i> Отзывы
                    </h3>
                    <button class="add-review-btn" id="addReviewBtn" onclick="openReviewModal()">
                        <i class="fas fa-plus"></i> Оставить отзыв
                    </button>
                </div>

                <!-- Average Rating -->
                <div class="average-rating" id="averageRating">
                    <div class="average-rating-value">0.0</div>
                    <div class="average-rating-details">
                        <div class="average-rating-stars" id="averageRatingStars"></div>
                        <div class="average-rating-text" id="averageRatingText">0 отзывов</div>
                    </div>
                    <div class="rating-bars" id="ratingBars"></div>
                </div>

                <!-- Reviews List -->
                <div class="reviews-list" id="reviewsList">
                    <div class="no-reviews" id="noReviews">
                        <i class="fas fa-comment-slash"></i>
                        <h4>Пока нет отзывов</h4>
                        <p>Будьте первым, кто оставит отзыв об этом товаре!</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="detail-actions">
            <button class="btn btn-accent" onclick="buyNow()" style="flex: 2;">
                <i class="fas fa-bolt"></i> Купить сейчас
            </button>
            <button class="btn btn-primary" id="detailCartBtn" onclick="toggleCartFromDetail()" style="flex: 1;">
                <i class="fas fa-shopping-cart"></i>
            </button>
        </div>
    </div>

    <!-- Review Modal -->
    <div class="review-modal" id="reviewModal">
        <div class="review-modal-header">
            <h3 class="review-modal-title">
                <i class="fas fa-star"></i> Оставить отзыв
            </h3>
            <button class="review-modal-close" onclick="closeReviewModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="review-modal-content">
            <div class="review-error" id="reviewError">
                Пожалуйста, заполните все поля
            </div>

            <div class="rating-input">
                <label>Ваша оценка:</label>
                <div class="stars-input">
                    <button class="star-btn" data-rating="1">
                        <i class="far fa-star"></i>
                    </button>
                    <button class="star-btn" data-rating="2">
                        <i class="far fa-star"></i>
                    </button>
                    <button class="star-btn" data-rating="3">
                        <i class="far fa-star"></i>
                    </button>
                    <button class="star-btn" data-rating="4">
                        <i class="far fa-star"></i>
                    </button>
                    <button class="star-btn" data-rating="5">
                        <i class="far fa-star"></i>
                    </button>
                </div>
                <div class="selected-rating-text" id="selectedRatingText">
                    Нажмите на звезду, чтобы оценить
                </div>
            </div>

            <div class="review-form-group">
                <label for="reviewText">Ваш отзыв:</label>
                <textarea 
                    class="review-textarea" 
                    id="reviewText" 
                    placeholder="Поделитесь своим мнением о товаре..."
                    maxlength="1000"
                ></textarea>
                <div style="text-align: right; font-size: 12px; color: var(--ozon-gray-50); margin-top: 4px;">
                    <span id="charCount">0</span>/1000 символов
                </div>
            </div>
        </div>
        <div class="review-form-actions">
            <button class="btn btn-secondary" onclick="closeReviewModal()" style="flex: 1;">
                Отмена
            </button>
            <button class="btn btn-primary" onclick="submitReview()" style="flex: 2;">
                Опубликовать отзыв
            </button>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // Конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC_XhDZ9rUv7wFlQkHMFwvkA5muZY4T-5I",
            authDomain: "estels-86a9c.firebaseapp.com",
            databaseURL: "https://estels-86a9c-default-rtdb.firebaseio.com",
            projectId: "estels-86a9c",
            storageBucket: "estels-86a9c.firebasestorage.app",
            messagingSenderId: "886795277090",
            appId: "1:886795277090:web:0e7cff9111d69e8b828b7b",
            measurementId: "G-FCH1Y0WX17"
        };

        // Инициализация Firebase
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            } else {
                firebase.app();
            }
        } catch (error) {
            console.error('Ошибка инициализации Firebase:', error);
        }

        const auth = firebase.auth();
        const database = firebase.database();
        const db = firebase.firestore();

        let currentUser = null;
        let favorites = [];
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let currentProduct = null;
        let productsCache = {};
        let selectedRating = 0;
        let productReviews = [];
        let productReviewStats = null;

        // DOM элементы
        const authContainer = document.getElementById('authContainer');
        const favoritesContainer = document.getElementById('favoritesContainer');
        const emptyFavorites = document.getElementById('emptyFavorites');
        const loadingContainer = document.getElementById('loadingContainer');
        const errorContainer = document.getElementById('errorContainer');
        const errorText = document.getElementById('errorText');
        const signInBtn = document.getElementById('signInBtn');
        const retryBtn = document.getElementById('retryBtn');
        const favoritesCountValue = document.getElementById('favoritesCountValue');
        const toast = document.getElementById('toast');

        // Обновление счетчика избранного
        function updateFavoritesCount() {
            favoritesCountValue.textContent = favorites.length;
            
            const favoritesCount = document.getElementById('favoritesCount');
            if (favorites.length > 0) {
                favoritesCount.style.display = 'flex';
            } else {
                favoritesCount.style.display = 'none';
            }
        }

        // Показать/скрыть уведомление
        function showToast(message, type = 'info') {
            toast.textContent = message;
            toast.className = 'toast';
            
            switch (type) {
                case 'success':
                    toast.classList.add('success');
                    break;
                case 'error':
                    toast.classList.add('error');
                    break;
                case 'info':
                    toast.classList.add('info');
                    break;
            }
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Проверка, есть ли товар в корзине
        function isInCart(productId) {
            return cart.some(item => item.id === productId);
        }

        // Получить количество товара в корзине
        function getCartQuantity(productId) {
            const item = cart.find(item => item.id === productId);
            return item ? item.quantity : 0;
        }

        // Обработчик ошибок
        function showError(message) {
            favoritesContainer.style.display = 'none';
            emptyFavorites.style.display = 'none';
            loadingContainer.style.display = 'none';
            errorContainer.style.display = 'block';
            errorText.textContent = message;
        }

        function hideError() {
            errorContainer.style.display = 'none';
        }

        // Аутентификация
        auth.onAuthStateChanged((user) => {
            console.log('Состояние аутентификации изменено:', user ? 'Вошёл' : 'Вышел');
            
            if (user) {
                currentUser = user;
                authContainer.style.display = 'none';
                loadingContainer.style.display = 'block';
                favoritesContainer.style.display = 'none';
                emptyFavorites.style.display = 'none';
                hideError();
                loadFavorites();
            } else {
                currentUser = null;
                authContainer.style.display = 'block';
                loadingContainer.style.display = 'none';
                favoritesContainer.innerHTML = '';
                favoritesContainer.style.display = 'none';
                emptyFavorites.style.display = 'none';
                hideError();
                updateFavoritesCount();
            }
        });

        // ОБНОВЛЕННЫЙ КОД ДЛЯ ВХОДА
        signInBtn.addEventListener('click', () => {
            // Показываем информационное уведомление вместо попытки входа через Google
            showToast('Для входа в аккаунт перейдите на главную страницу магазина', 'info');
            
            // Опционально: перенаправляем на главную страницу через 2 секунды
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);
        });

        // Повторная попытка загрузки
        retryBtn.addEventListener('click', () => {
            if (currentUser) {
                hideError();
                loadingContainer.style.display = 'block';
                loadFavorites();
            }
        });

        // Загрузка избранного
        function loadFavorites() {
            if (!currentUser) {
                showError('Пользователь не авторизован');
                return;
            }

            console.log('Загрузка избранного для пользователя:', currentUser.uid);

            loadingContainer.style.display = 'block';
            favoritesContainer.style.display = 'none';
            emptyFavorites.style.display = 'none';
            hideError();

            // Загружаем корзину из localStorage
            cart = JSON.parse(localStorage.getItem('cart')) || [];

            database.ref('users/' + currentUser.uid + '/favorites').once('value')
                .then((snapshot) => {
                    console.log('Данные получены из Firebase:', snapshot.val());
                    loadingContainer.style.display = 'none';
                    processFavoritesData(snapshot.val());
                })
                .catch((error) => {
                    console.error('Ошибка загрузки избранного:', error);
                    loadingContainer.style.display = 'none';
                    
                    // Обработка ошибок Firebase
                    if (error.code === 'auth/operation-not-supported-in-this-environment') {
                        // Для локальной разработки показываем демо-данные
                        console.log('Используем демо-данные для локальной разработки');
                        simulateFavoritesData();
                    } else {
                        showError('Не удалось загрузить избранное. Проверьте подключение к интернету.');
                        showToast('Ошибка загрузки избранного', 'error');
                    }
                });
        }

        // Функция для симуляции демо-данных (для локальной разработки)
        function simulateFavoritesData() {
            console.log('Загружаем демо-данные избранного');
            
            // Демо-данные избранного
            const demoFavorites = [
                {
                    id: 'demo1',
                    name: 'Увлажняющий крем для лица',
                    desc: 'Интенсивное увлажнение на 24 часа',
                    price: 1499,
                    oldPrice: 1999,
                    image: 'https://images.unsplash.com/photo-1556228578-9c360e1d8d34?w=400&h=400&fit=crop',
                    category: 'face',
                    brand: 'la_roche',
                    rating: 4.7,
                    reviews: 128,
                    firebaseKey: 'demo_key_1',
                    dateAdded: Date.now() - 86400000 // 1 день назад
                },
                {
                    id: 'demo2',
                    name: 'Очищающий гель',
                    desc: 'Мягкое очищение без сухости',
                    price: 899,
                    oldPrice: null,
                    image: 'https://images.unsplash.com/photo-1556228453-efd6c1ff04f6?w=400&h=400&fit=crop',
                    category: 'face',
                    brand: 'cerave',
                    rating: 4.5,
                    reviews: 89,
                    firebaseKey: 'demo_key_2',
                    dateAdded: Date.now() - 172800000 // 2 дня назад
                },
                {
                    id: 'demo3',
                    name: 'Сыворотка с гиалуроновой кислотой',
                    desc: 'Глубокое увлажнение и разглаживание морщин',
                    price: 2499,
                    oldPrice: 2999,
                    image: 'https://images.unsplash.com/photo-1596462502278-27bfdc403348?w=400&h=400&fit=crop',
                    category: 'face',
                    brand: 'ordinary',
                    rating: 4.9,
                    reviews: 256,
                    firebaseKey: 'demo_key_3',
                    dateAdded: Date.now() - 259200000 // 3 дня назад
                }
            ];

            favorites = demoFavorites;
            updateFavoritesCount();
            renderFavorites();
            
            // Показываем информационное сообщение
            showToast('Демо-режим: показаны примеры избранных товаров', 'info');
        }

        // Обработка данных избранного
        function processFavoritesData(data) {
            favorites = [];

            if (data) {
                Object.keys(data).forEach((key) => {
                    const favoriteData = data[key];
                    
                    if (favoriteData && favoriteData.productId) {
                        const product = {
                            id: favoriteData.productId,
                            name: favoriteData.name || 'Товар',
                            desc: favoriteData.desc || favoriteData.description || '',
                            price: favoriteData.price || 0,
                            oldPrice: favoriteData.oldPrice || null,
                            image: favoriteData.image || 'https://images.unsplash.com/photo-1556228578-9c360e1d8d34?w=400&h=400&fit=crop',
                            category: favoriteData.category || 'other',
                            brand: favoriteData.brand || 'other',
                            rating: favoriteData.rating || 0,
                            reviews: favoriteData.reviews || 0,
                            firebaseKey: key,
                            dateAdded: favoriteData.dateAdded || Date.now()
                        };
                        favorites.push(product);
                    }
                });
            }

            console.log('Всего избранных товаров:', favorites.length);
            updateFavoritesCount();
            renderFavorites();
        }

        // Рендеринг избранного с использованием модального окна вместо перехода на страницу
        function renderFavorites() {
            favoritesContainer.innerHTML = '';
            
            if (favorites.length === 0) {
                favoritesContainer.style.display = 'none';
                emptyFavorites.style.display = 'block';
                console.log('Нет избранных товаров для отображения');
                return;
            }

            favoritesContainer.style.display = 'grid';
            emptyFavorites.style.display = 'none';

            // Сортируем по дате добавления (новые первыми)
            favorites.sort((a, b) => (b.dateAdded || 0) - (a.dateAdded || 0));

            favorites.forEach((item, index) => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.style.animationDelay = `${index * 0.1}s`;
                productCard.setAttribute('data-product-id', item.id);
                
                // Добавляем обработчик клика по всей карточке для открытия модального окна
                productCard.addEventListener('click', function(e) {
                    // Проверяем, что клик не был на кнопке избранного или кнопке корзины
                    if (!e.target.closest('.favorite-btn') && 
                        !e.target.closest('.qty-btn')) {
                        openProductDetail(item.id);
                    }
                });

                // Проверяем, есть ли товар в корзине
                const inCart = isInCart(item.id);
                const quantity = getCartQuantity(item.id);

                productCard.innerHTML = `
                    <button class="favorite-btn active" onclick="removeFromFavorites('${item.firebaseKey}', '${item.id}')">
                        <i class="fas fa-heart"></i>
                    </button>
                    <div class="product-image">
                        <img src="${item.image}" alt="${escapeHtml(item.name)}" loading="lazy"
                            onerror="this.src='https://images.unsplash.com/photo-1556228578-9c360e1d8d34?w=400&h=400&fit=crop'">
                    </div>
                    <div class="product-info">
                        <div class="product-category">
                            <i class="fas fa-tag"></i> ${getCategoryName(item.category)}
                        </div>
                        <h3 class="product-title">${escapeHtml(item.name)}</h3>
                        ${item.rating ? `
                        <div class="product-rating">
                            <div class="stars">
                                ${getStars(item.rating)}
                            </div>
                            <span class="rating-value">${item.rating.toFixed(1)}</span>
                            <span class="rating-count">(${item.reviews})</span>
                        </div>
                        ` : ''}
                        <div class="product-price">
                            ${formatPrice(item.price)} ₽
                            ${item.oldPrice ? `<span class="old-price">${formatPrice(item.oldPrice)} ₽</span>` : ''}
                        </div>
                        <div class="cart-controls" id="cartControls-${item.id}">
                            ${inCart ? `
                                <div class="quantity-controls">
                                    <button class="qty-btn" onclick="event.stopPropagation(); decreaseQuantity('${item.id}', '${escapeHtml(item.name)}')">-</button>
                                    <span class="quantity">${quantity}</span>
                                    <button class="qty-btn" onclick="event.stopPropagation(); increaseQuantity('${item.id}', '${escapeHtml(item.name)}')">+</button>
                                </div>
                            ` : `
                                <button class="add-to-cart-btn" onclick="event.stopPropagation(); addToCart('${item.id}', '${escapeHtml(item.name)}', ${item.price}, '${item.image}', '${item.category}')">
                                    <i class="fas fa-shopping-cart"></i> В корзину
                                </button>
                            `}
                        </div>
                    </div>
                `;

                favoritesContainer.appendChild(productCard);
            });
        }

        // Открытие детальной страницы товара в модальном окне
        async function openProductDetail(productId) {
            try {
                // Показываем загрузку
                const detailTitle = document.getElementById('detailTitle');
                detailTitle.textContent = 'Загрузка...';
                
                // Проверяем кэш
                if (productsCache[productId]) {
                    currentProduct = productsCache[productId];
                    fillProductDetail(currentProduct);
                } else {
                    // Загружаем полные данные о товаре из Firestore
                    const doc = await db.collection('products').doc(productId).get();
                    
                    if (doc.exists) {
                        const data = doc.data();
                        currentProduct = {
                            id: doc.id,
                            name: data.name || 'Товар',
                            category: data.category || 'other',
                            brand: data.brand || 'other',
                            skinType: data.skinType || [],
                            price: data.price || 0,
                            oldPrice: data.oldPrice || null,
                            image: data.image || 'https://images.unsplash.com/photo-1556228578-9c360e1d8d34?w=400&h=400&fit=crop',
                            images: data.images || [data.image || 'https://images.unsplash.com/photo-1556228578-9c360e1d8d34?w=400&h=400&fit=crop'],
                            rating: data.rating || 0,
                            reviews: data.reviews || 0,
                            sales: data.sales || 0,
                            description: data.description || 'Описание отсутствует',
                            volume: data.volume || '50 мл',
                            country: data.country || 'Не указано',
                            inStock: data.inStock !== false
                        };
                        
                        // Сохраняем в кэш
                        productsCache[productId] = currentProduct;
                        
                        fillProductDetail(currentProduct);
                    } else {
                        // Если товар не найден в Firestore, используем данные из избранного
                        const favoriteItem = favorites.find(item => item.id === productId);
                        if (favoriteItem) {
                            currentProduct = {
                                ...favoriteItem,
                                images: [favoriteItem.image],
                                volume: '50 мл',
                                country: 'Не указано',
                                skinType: []
                            };
                            fillProductDetail(currentProduct);
                        } else {
                            showToast('Товар не найден', 'error');
                            return;
                        }
                    }
                }
                
                // Загружаем отзывы для этого товара
                loadProductReviews(productId);
                
                // Показываем модальное окно
                document.getElementById('productDetail').classList.add('active');
                
            } catch (error) {
                console.error('Ошибка загрузки товара:', error);
                showToast('Ошибка загрузки товара', 'error');
            }
        }

        // Заполнение данных в модальном окне
        function fillProductDetail(product) {
            // Заполняем основные данные
            document.getElementById('detailTitle').textContent = product.name;
            document.getElementById('detailCategory').textContent = getCategoryName(product.category);
            document.getElementById('detailRating').textContent = product.rating.toFixed(1);
            document.getElementById('detailCurrentPrice').textContent = formatPrice(product.price) + ' ₽';
            document.getElementById('detailOldPrice').textContent = product.oldPrice ? formatPrice(product.oldPrice) + ' ₽' : '';
            document.getElementById('detailDescription').textContent = product.description;
            document.getElementById('specBrand').textContent = getBrandName(product.brand);
            document.getElementById('specSkinType').textContent = getSkinTypeName(product.skinType);
            document.getElementById('specVolume').textContent = product.volume;
            document.getElementById('specCountry').textContent = product.country;

            // Настройка слайдера изображений
            const slider = document.getElementById('imageSlider');
            const controls = document.getElementById('sliderControls');
            slider.innerHTML = '';
            controls.innerHTML = '';

            product.images.forEach((img, index) => {
                const slide = document.createElement('div');
                slide.className = 'image-slide';
                slide.innerHTML = `<img src="${img}" alt="${product.name} ${index + 1}" loading="lazy">`;
                slider.appendChild(slide);

                const dot = document.createElement('button');
                dot.className = `slider-dot ${index === 0 ? 'active' : ''}`;
                dot.onclick = () => goToSlide(index);
                controls.appendChild(dot);
            });

            // Настройка кнопки корзины
            const inCart = cart.some(item => item.id === product.id);
            const cartBtn = document.getElementById('detailCartBtn');
            if (inCart) {
                cartBtn.innerHTML = '<i class="fas fa-check"></i>';
                cartBtn.classList.add('added');
            } else {
                cartBtn.innerHTML = '<i class="fas fa-shopping-cart"></i>';
                cartBtn.classList.remove('added');
            }
            
            // Show/hide add review button based on auth
            const addReviewBtn = document.getElementById('addReviewBtn');
            if (currentUser) {
                addReviewBtn.style.display = 'flex';
            } else {
                addReviewBtn.style.display = 'none';
            }
        }

        // Закрытие модального окна
        function closeProductDetail() {
            document.getElementById('productDetail').classList.remove('active');
        }

        // Переключение между слайдами
        function goToSlide(index) {
            const slides = document.querySelectorAll('.image-slide');
            const dots = document.querySelectorAll('.slider-dot');
            const slider = document.getElementById('imageSlider');

            slides.forEach(slide => slide.classList.remove('active'));
            dots.forEach(dot => dot.classList.remove('active'));

            slides[index].classList.add('active');
            dots[index].classList.add('active');
            slider.style.transform = `translateX(-${index * 100}%)`;
        }

        // Select rating in review modal
        function selectRating(rating) {
            selectedRating = rating;
            const stars = document.querySelectorAll('.star-btn');
            stars.forEach(star => {
                const starRating = parseInt(star.dataset.rating);
                if (starRating <= rating) {
                    star.innerHTML = '<i class="fas fa-star"></i>';
                    star.classList.add('active');
                } else {
                    star.innerHTML = '<i class="far fa-star"></i>';
                    star.classList.remove('active');
                }
            });
            
            const ratingTexts = [
                'Ужасно',
                'Плохо',
                'Нормально',
                'Хорошо',
                'Отлично'
            ];
            document.getElementById('selectedRatingText').textContent = ratingTexts[rating - 1];
        }

        // Open review modal
        function openReviewModal() {
            if (!currentUser) {
                showToast('Войдите в систему, чтобы оставить отзыв', 'error');
                return;
            }
            
            if (!currentProduct) {
                showToast('Ошибка: товар не найден', 'error');
                return;
            }
            
            // Check if user already left a review
            const userReview = productReviews.find(review => review.userId === currentUser.uid);
            if (userReview) {
                showToast('Вы уже оставили отзыв на этот товар', 'info');
                return;
            }
            
            // Reset form
            selectedRating = 0;
            document.getElementById('reviewText').value = '';
            document.getElementById('charCount').textContent = '0';
            document.getElementById('reviewError').classList.remove('show');
            
            // Reset stars
            const stars = document.querySelectorAll('.star-btn');
            stars.forEach(star => {
                star.innerHTML = '<i class="far fa-star"></i>';
                star.classList.remove('active');
            });
            
            document.getElementById('selectedRatingText').textContent = 'Нажмите на звезду, чтобы оценить';
            
            // Show modal
            document.getElementById('reviewModal').classList.add('active');
        }

        // Close review modal
        function closeReviewModal() {
            document.getElementById('reviewModal').classList.remove('active');
        }

        // Submit review
        function submitReview() {
            if (!currentUser) {
                showToast('Войдите в систему, чтобы оставить отзыв', 'error');
                return;
            }
            
            if (!currentProduct) {
                showToast('Ошибка: товар не найден', 'error');
                return;
            }
            
            if (selectedRating === 0) {
                document.getElementById('reviewError').textContent = 'Пожалуйста, выберите оценку';
                document.getElementById('reviewError').classList.add('show');
                return;
            }
            
            const reviewText = document.getElementById('reviewText').value.trim();
            if (reviewText.length < 10) {
                document.getElementById('reviewError').textContent = 'Отзыв должен содержать минимум 10 символов';
                document.getElementById('reviewError').classList.add('show');
                return;
            }
            
            if (reviewText.length > 1000) {
                document.getElementById('reviewError').textContent = 'Отзыв не должен превышать 1000 символов';
                document.getElementById('reviewError').classList.add('show');
                return;
            }
            
            // Check if user already left a review
            const userReview = productReviews.find(review => review.userId === currentUser.uid);
            if (userReview) {
                showToast('Вы уже оставили отзыв на этот товар', 'info');
                closeReviewModal();
                return;
            }
            
            // Create review object
            const review = {
                productId: currentProduct.id,
                userId: currentUser.uid,
                userName: currentUser.displayName || currentUser.email.split('@')[0],
                userAvatar: currentUser.photoURL || null,
                rating: selectedRating,
                text: reviewText,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Save review to Firestore
            db.collection('reviews').add(review)
                .then(() => {
                    showToast('Ваш отзыв успешно опубликован!', 'success');
                    closeReviewModal();
                    
                    // Update product rating statistics
                    updateProductRatingStats();
                    
                    // Reload reviews
                    loadProductReviews(currentProduct.id);
                })
                .catch((error) => {
                    console.error('Ошибка при сохранении отзыва:', error);
                    showToast('Ошибка при сохранении отзыва', 'error');
                });
        }

        // Update product rating statistics
        function updateProductRatingStats() {
            if (!currentProduct) return;
            
            // Calculate new average rating
            const reviews = productReviews;
            const newReview = {
                rating: selectedRating
            };
            
            // Add the new review temporarily for calculation
            const allReviews = [...reviews, newReview];
            const totalRating = allReviews.reduce((sum, review) => sum + review.rating, 0);
            const averageRating = totalRating / allReviews.length;
            
            // Count ratings by star
            const ratingCounts = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0};
            allReviews.forEach(review => {
                ratingCounts[review.rating]++;
            });
            
            // Update product in Firestore
            db.collection('products').doc(currentProduct.id).update({
                rating: parseFloat(averageRating.toFixed(1)),
                reviews: allReviews.length,
                ratingCounts: ratingCounts,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                console.log('Рейтинг товара обновлен');
                
                // Update current product data
                currentProduct.rating = parseFloat(averageRating.toFixed(1));
                currentProduct.reviews = allReviews.length;
                
                // Update favorites array
                const favoriteIndex = favorites.findIndex(f => f.id === currentProduct.id);
                if (favoriteIndex !== -1) {
                    favorites[favoriteIndex].rating = currentProduct.rating;
                    favorites[favoriteIndex].reviews = currentProduct.reviews;
                }
                
                // Update UI
                updateProductRatingDisplay();
                renderFavorites();
            })
            .catch((error) => {
                console.error('Ошибка при обновлении рейтинга товара:', error);
            });
        }

        // Update product rating display
        function updateProductRatingDisplay() {
            if (!currentProduct) return;
            
            const detailRating = document.getElementById('detailRating');
            if (detailRating) {
                detailRating.textContent = currentProduct.rating.toFixed(1);
            }
            
            updateAverageRatingDisplay();
        }

        // Update average rating display
        function updateAverageRatingDisplay() {
            if (!productReviewStats) return;
            
            const averageRatingValue = document.querySelector('.average-rating-value');
            const averageRatingStars = document.getElementById('averageRatingStars');
            const averageRatingText = document.getElementById('averageRatingText');
            const ratingBars = document.getElementById('ratingBars');
            
            if (averageRatingValue) {
                averageRatingValue.textContent = productReviewStats.averageRating.toFixed(1);
            }
            
            if (averageRatingStars) {
                averageRatingStars.innerHTML = getStars(productReviewStats.averageRating);
            }
            
            if (averageRatingText) {
                const reviewCount = productReviews.length;
                const word = getReviewWord(reviewCount);
                averageRatingText.textContent = `${reviewCount} ${word}`;
            }
            
            if (ratingBars) {
                ratingBars.innerHTML = '';
                
                // Create rating bars for each star rating
                for (let i = 5; i >= 1; i--) {
                    const count = productReviewStats.ratingCounts[i] || 0;
                    const percentage = productReviews.length > 0 ? (count / productReviews.length) * 100 : 0;
                    
                    const ratingBar = document.createElement('div');
                    ratingBar.className = 'rating-bar';
                    ratingBar.innerHTML = `
                        <span class="rating-bar-label">${i} <i class="fas fa-star"></i></span>
                        <div class="rating-bar-progress">
                            <div class="rating-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                        <span class="rating-bar-count">${count}</span>
                    `;
                    ratingBars.appendChild(ratingBar);
                }
            }
        }

        // Get correct word form for review count
        function getReviewWord(count) {
            if (count % 10 === 1 && count % 100 !== 11) return 'отзыв';
            if (count % 10 >= 2 && count % 10 <= 4 && (count % 100 < 10 || count % 100 >= 20)) return 'отзыва';
            return 'отзывов';
        }

        // Load product reviews
        function loadProductReviews(productId) {
            productReviews = [];
            productReviewStats = null;
            
            // Listen for reviews in real-time
            db.collection('reviews')
                .where('productId', '==', productId)
                .orderBy('createdAt', 'desc')
                .onSnapshot((snapshot) => {
                    productReviews = [];
                    snapshot.forEach(doc => {
                        const review = doc.data();
                        review.id = doc.id;
                        // Convert Firestore timestamp to Date
                        if (review.createdAt && review.createdAt.toDate) {
                            review.createdAt = review.createdAt.toDate();
                        }
                        if (review.updatedAt && review.updatedAt.toDate) {
                            review.updatedAt = review.updatedAt.toDate();
                        }
                        productReviews.push(review);
                    });
                    
                    // Calculate review statistics
                    calculateReviewStats();
                    
                    // Update UI
                    updateReviewsList();
                    updateAverageRatingDisplay();
                }, (error) => {
                    console.error('Ошибка загрузки отзывов:', error);
                });
        }

        // Calculate review statistics
        function calculateReviewStats() {
            if (productReviews.length === 0) {
                productReviewStats = {
                    averageRating: 0,
                    ratingCounts: {1: 0, 2: 0, 3: 0, 4: 0, 5: 0}
                };
                return;
            }
            
            const totalRating = productReviews.reduce((sum, review) => sum + review.rating, 0);
            const averageRating = totalRating / productReviews.length;
            
            const ratingCounts = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0};
            productReviews.forEach(review => {
                ratingCounts[review.rating]++;
            });
            
            productReviewStats = {
                averageRating: averageRating,
                ratingCounts: ratingCounts
            };
        }

        // Update reviews list
        function updateReviewsList() {
            const reviewsList = document.getElementById('reviewsList');
            const noReviews = document.getElementById('noReviews');
            
            if (!reviewsList || !noReviews) return;
            
            if (productReviews.length === 0) {
                noReviews.style.display = 'block';
                // Clear existing reviews
                const existingReviews = reviewsList.querySelectorAll('.review-item');
                existingReviews.forEach(review => review.remove());
                return;
            }
            
            noReviews.style.display = 'none';
            
            // Clear existing reviews
            const existingReviews = reviewsList.querySelectorAll('.review-item');
            existingReviews.forEach(review => review.remove());
            
            // Add new reviews
            productReviews.forEach(review => {
                const reviewItem = document.createElement('div');
                reviewItem.className = 'review-item';
                
                // Format date
                const date = review.createdAt ? formatDate(review.createdAt) : 'Недавно';
                
                // Get user avatar initials
                let avatarText = 'П';
                if (review.userName) {
                    avatarText = review.userName.charAt(0).toUpperCase();
                } else if (review.userId) {
                    avatarText = review.userId.charAt(0).toUpperCase();
                }
                
                reviewItem.innerHTML = `
                    <div class="review-header">
                        <div class="review-avatar">
                            ${avatarText}
                        </div>
                        <div class="review-user">
                            <div class="review-user-name">${review.userName || 'Пользователь'}</div>
                            <div class="review-date">${date}</div>
                        </div>
                        <div class="review-rating">
                            ${getStars(review.rating)}
                        </div>
                    </div>
                    <div class="review-text">
                        ${escapeHtml(review.text)}
                    </div>
                    <div class="review-footer">
                        <div class="review-helpful">
                            <i class="far fa-thumbs-up"></i> Полезно
                        </div>
                        ${review.userId === currentUser?.uid ? '<div class="review-own">Ваш отзыв</div>' : ''}
                    </div>
                `;
                
                reviewsList.appendChild(reviewItem);
            });
        }

        // Format date
        function formatDate(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMins < 1) return 'Только что';
            if (diffMins < 60) return `${diffMins} мин. назад`;
            if (diffHours < 24) return `${diffHours} ч. назад`;
            if (diffDays === 1) return 'Вчера';
            if (diffDays < 7) return `${diffDays} дн. назад`;
            
            return date.toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        // Удаление из избранного
        function removeFromFavorites(firebaseKey, productId) {
            if (!currentUser) {
                showToast('Войдите в систему, чтобы управлять избранным', 'error');
                return;
            }

            const item = favorites.find(item => item.firebaseKey === firebaseKey);
            if (!item) return;

            // Удалить из Firebase
            database.ref('users/' + currentUser.uid + '/favorites/' + firebaseKey).remove()
                .then(() => {
                    // Удалить из локального массива
                    favorites = favorites.filter(item => item.firebaseKey !== firebaseKey);
                    
                    // Обновить счетчик и отображение
                    updateFavoritesCount();
                    renderFavorites();
                    
                    // Показать уведомление
                    showToast(`${item.name} удален из избранного`, 'info');
                    
                    // Отправляем событие для обновления на других страницах
                    window.dispatchEvent(new CustomEvent('favoriteRemoved', { 
                        detail: { productId: productId } 
                    }));
                })
                .catch((error) => {
                    console.error('Ошибка удаления:', error);
                    showError('Не удалось удалить товар из избранного');
                    showToast('Ошибка при удалении товара', 'error');
                });
        }

        // Добавление в корзину
        function addToCart(productId, productName, productPrice, productImage, productCategory) {
            cart = JSON.parse(localStorage.getItem('cart')) || [];
            const existingItem = cart.find(cartItem => cartItem.id === productId);

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    id: productId,
                    name: productName,
                    price: productPrice,
                    image: productImage,
                    category: productCategory,
                    quantity: 1
                });
            }

            localStorage.setItem('cart', JSON.stringify(cart));
            
            // Обновляем отображение кнопки
            updateCartButton(productId, true);
            
            showToast(`${productName} добавлен в корзину`, 'success');
        }

        // Увеличение количества
        function increaseQuantity(productId, productName) {
            cart = JSON.parse(localStorage.getItem('cart')) || [];
            const item = cart.find(item => item.id === productId);
            
            if (item) {
                item.quantity += 1;
                localStorage.setItem('cart', JSON.stringify(cart));
                
                // Обновляем отображение
                updateQuantityDisplay(productId, item.quantity);
                
                showToast(`Количество "${productName}" увеличено до ${item.quantity}`, 'info');
            }
        }

        // Уменьшение количества
        function decreaseQuantity(productId, productName) {
            cart = JSON.parse(localStorage.getItem('cart')) || [];
            const item = cart.find(item => item.id === productId);
            
            if (item) {
                if (item.quantity > 1) {
                    item.quantity -= 1;
                    localStorage.setItem('cart', JSON.stringify(cart));
                    
                    // Обновляем отображение
                    updateQuantityDisplay(productId, item.quantity);
                    
                    showToast(`Количество "${productName}" уменьшено до ${item.quantity}`, 'info');
                } else {
                    // Удаляем товар из корзины
                    cart = cart.filter(item => item.id !== productId);
                    localStorage.setItem('cart', JSON.stringify(cart));
                    
                    // Обновляем кнопку
                    updateCartButton(productId, false);
                    
                    showToast(`${productName} удален из корзины`, 'info');
                }
            }
        }

        // Обновление отображения количества
        function updateQuantityDisplay(productId, quantity) {
            const quantityElement = document.querySelector(`[data-product-id="${productId}"] .quantity`);
            if (quantityElement) {
                quantityElement.textContent = quantity;
            }
        }

        // Обновление кнопки корзины
        function updateCartButton(productId, inCart, quantity = 1) {
            const cartControls = document.getElementById(`cartControls-${productId}`);
            const item = favorites.find(item => item.id === productId);
            
            if (!item) return;
            
            if (inCart) {
                cartControls.innerHTML = `
                    <div class="quantity-controls">
                        <button class="qty-btn" onclick="event.stopPropagation(); decreaseQuantity('${productId}', '${escapeHtml(item.name)}')">-</button>
                        <span class="quantity">${quantity}</span>
                        <button class="qty-btn" onclick="event.stopPropagation(); increaseQuantity('${productId}', '${escapeHtml(item.name)}')">+</button>
                    </div>
                `;
            } else {
                cartControls.innerHTML = `
                    <button class="add-to-cart-btn" onclick="event.stopPropagation(); addToCart('${productId}', '${escapeHtml(item.name)}', ${item.price}, '${item.image}', '${item.category}')">
                        <i class="fas fa-shopping-cart"></i> В корзину
                    </button>
                `;
            }
        }

        // Переключение корзины из детального окна
        function toggleCartFromDetail() {
            if (!currentProduct) return;

            const existingIndex = cart.findIndex(item => item.id === currentProduct.id);
            const cartBtn = document.getElementById('detailCartBtn');

            if (existingIndex === -1) {
                // Добавляем в корзину
                cart.push({
                    ...currentProduct,
                    quantity: 1
                });
                localStorage.setItem('cart', JSON.stringify(cart));

                cartBtn.innerHTML = '<i class="fas fa-check"></i>';
                cartBtn.classList.add('added');

                showToast('Товар добавлен в корзину', 'success');
            } else {
                // Удаляем из корзины
                cart.splice(existingIndex, 1);
                localStorage.setItem('cart', JSON.stringify(cart));

                cartBtn.innerHTML = '<i class="fas fa-shopping-cart"></i>';
                cartBtn.classList.remove('added');

                showToast('Товар удален из корзины', 'info');
            }
            
            // Обновляем отображение на карточке
            updateCartButton(currentProduct.id, existingIndex === -1);
        }

        // Купить сейчас
        function buyNow() {
            if (!currentProduct) return;

            // Сначала добавляем в корзину
            const existingIndex = cart.findIndex(item => item.id === currentProduct.id);
            if (existingIndex === -1) {
                cart.push({
                    ...currentProduct,
                    quantity: 1
                });
                localStorage.setItem('cart', JSON.stringify(cart));
            }

            // Закрываем модальное окно и переходим в корзину
            closeProductDetail();
            setTimeout(() => {
                window.location.href = 'cart.html';
            }, 300);
        }

        // Вспомогательные функции
        function getCategoryName(category) {
            const categories = {
                'face': 'Лицо',
                'body': 'Тело',
                'hair': 'Волосы',
                'sunscreen': 'Защита',
                'other': 'Другое'
            };
            return categories[category] || category;
        }

        function getBrandName(brand) {
            const brands = {
                'la_roche': 'La Roche-Posay',
                'cerave': 'CeraVe',
                'ordinary': 'The Ordinary',
                'avene': 'Avene',
                'other': 'Другой'
            };
            return brands[brand] || brand;
        }

        function getSkinTypeName(skinType) {
            const types = {
                'normal': 'Нормальная',
                'dry': 'Сухая',
                'oily': 'Жирная',
                'sensitive': 'Чувствительная',
                'all': 'Любой'
            };
            if (Array.isArray(skinType)) {
                return skinType.map(t => types[t] || t).join(', ');
            }
            return types[skinType] || skinType;
        }

        function getStars(rating) {
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;
            let stars = '';

            for (let i = 0; i < 5; i++) {
                if (i < fullStars) {
                    stars += '<i class="fas fa-star"></i>';
                } else if (i === fullStars && halfStar) {
                    stars += '<i class="fas fa-star-half-alt"></i>';
                } else {
                    stars += '<i class="far fa-star"></i>';
                }
            }
            return stars;
        }

        // Форматирование цены
        function formatPrice(price) {
            return price ? price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ') : '0';
        }

        // Экранирование HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Запуск при загрузке страницы
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Страница избранного загружена');
            
            // Загружаем корзину из localStorage
            cart = JSON.parse(localStorage.getItem('cart')) || [];
            
            // Добавляем обработчик для кнопки назад
            document.querySelector('.back-btn').addEventListener('click', () => {
                window.history.back();
            });
            
            // Закрытие модального окна при клике на темную область
            document.getElementById('productDetail').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeProductDetail();
                }
            });
            
            // Закрытие модального окна по клавише Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeProductDetail();
                }
            });
            
            // Initialize review modal stars
            document.querySelectorAll('.star-btn').forEach(star => {
                star.addEventListener('click', function () {
                    const rating = parseInt(this.dataset.rating);
                    selectRating(rating);
                });
            });

            // Review text character counter
            const reviewText = document.getElementById('reviewText');
            const charCount = document.getElementById('charCount');
            
            if (reviewText && charCount) {
                reviewText.addEventListener('input', function () {
                    charCount.textContent = this.value.length;
                });
            }
        });

        // Обработка ошибок сети
        window.addEventListener('offline', function () {
            console.log('Отсутствует подключение к интернету');
            if (currentUser) {
                showError('Отсутствует подключение к интернету');
                showToast('Отсутствует подключение к интернету', 'error');
            }
        });

        window.addEventListener('online', function () {
            console.log('Подключение к интернету восстановлено');
            if (currentUser && errorContainer.style.display === 'block') {
                hideError();
                loadingContainer.style.display = 'block';
                loadFavorites();
                showToast('Подключение восстановлено', 'success');
            }
        });
    </script>
</body>
</html>